<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[十二] Spring的事务管理 - 声明式事务 | 叶良辰の学习笔记</title>
    <meta name="description" content="万物之始,大道至简,衍化至繁">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.94a75534.css" as="style"><link rel="preload" href="/assets/js/app.8595a84a.js" as="script"><link rel="preload" href="/assets/js/2.43ea25e1.js" as="script"><link rel="preload" href="/assets/js/143.d4c9a677.js" as="script"><link rel="preload" href="/assets/js/10.06e5eb14.js" as="script"><link rel="prefetch" href="/assets/js/100.31901176.js"><link rel="prefetch" href="/assets/js/101.ded6a7c2.js"><link rel="prefetch" href="/assets/js/102.8c41fe6e.js"><link rel="prefetch" href="/assets/js/103.fd055c57.js"><link rel="prefetch" href="/assets/js/104.c2912d2f.js"><link rel="prefetch" href="/assets/js/105.cb7a5631.js"><link rel="prefetch" href="/assets/js/106.5ab6db1d.js"><link rel="prefetch" href="/assets/js/107.b2479aa0.js"><link rel="prefetch" href="/assets/js/108.f6f20e89.js"><link rel="prefetch" href="/assets/js/109.e31b7441.js"><link rel="prefetch" href="/assets/js/11.f086bb6e.js"><link rel="prefetch" href="/assets/js/110.b3c1c320.js"><link rel="prefetch" href="/assets/js/111.6bc1ba48.js"><link rel="prefetch" href="/assets/js/112.aaf73c2c.js"><link rel="prefetch" href="/assets/js/113.bbc02c2b.js"><link rel="prefetch" href="/assets/js/114.fd4aac87.js"><link rel="prefetch" href="/assets/js/115.a3cd54c2.js"><link rel="prefetch" href="/assets/js/116.21a147a9.js"><link rel="prefetch" href="/assets/js/117.959f6d38.js"><link rel="prefetch" href="/assets/js/118.bccc0c41.js"><link rel="prefetch" href="/assets/js/119.f774debc.js"><link rel="prefetch" href="/assets/js/12.578f8496.js"><link rel="prefetch" href="/assets/js/120.84f1ed9b.js"><link rel="prefetch" href="/assets/js/121.90ef0752.js"><link rel="prefetch" href="/assets/js/122.3a4d8cd7.js"><link rel="prefetch" href="/assets/js/123.4d9a5cbf.js"><link rel="prefetch" href="/assets/js/124.83bad0ab.js"><link rel="prefetch" href="/assets/js/125.bbe455b0.js"><link rel="prefetch" href="/assets/js/126.1977c201.js"><link rel="prefetch" href="/assets/js/127.cccee27c.js"><link rel="prefetch" href="/assets/js/128.ad9031a7.js"><link rel="prefetch" href="/assets/js/129.5f46be27.js"><link rel="prefetch" href="/assets/js/13.f4e25669.js"><link rel="prefetch" href="/assets/js/130.b8d3df87.js"><link rel="prefetch" href="/assets/js/131.367e4e63.js"><link rel="prefetch" href="/assets/js/132.91dec612.js"><link rel="prefetch" href="/assets/js/133.f550ada4.js"><link rel="prefetch" href="/assets/js/134.b5f777e1.js"><link rel="prefetch" href="/assets/js/135.77c69367.js"><link rel="prefetch" href="/assets/js/136.e498ba84.js"><link rel="prefetch" href="/assets/js/137.fc3751d8.js"><link rel="prefetch" href="/assets/js/138.8bba551f.js"><link rel="prefetch" href="/assets/js/139.3c70edb9.js"><link rel="prefetch" href="/assets/js/14.be534530.js"><link rel="prefetch" href="/assets/js/140.5505027f.js"><link rel="prefetch" href="/assets/js/141.0afcfd78.js"><link rel="prefetch" href="/assets/js/142.6ab0accb.js"><link rel="prefetch" href="/assets/js/144.ef861a7b.js"><link rel="prefetch" href="/assets/js/145.098367bf.js"><link rel="prefetch" href="/assets/js/146.76222e89.js"><link rel="prefetch" href="/assets/js/147.674e9f71.js"><link rel="prefetch" href="/assets/js/148.555c3ed1.js"><link rel="prefetch" href="/assets/js/149.603f6336.js"><link rel="prefetch" href="/assets/js/15.2e485db6.js"><link rel="prefetch" href="/assets/js/150.76507a6a.js"><link rel="prefetch" href="/assets/js/151.59914096.js"><link rel="prefetch" href="/assets/js/152.ccc3e17c.js"><link rel="prefetch" href="/assets/js/153.e69220a8.js"><link rel="prefetch" href="/assets/js/154.fa22c457.js"><link rel="prefetch" href="/assets/js/155.d499ebb6.js"><link rel="prefetch" href="/assets/js/156.bfe40f62.js"><link rel="prefetch" href="/assets/js/157.bb6fc26c.js"><link rel="prefetch" href="/assets/js/158.c8914f45.js"><link rel="prefetch" href="/assets/js/159.bf52f2be.js"><link rel="prefetch" href="/assets/js/16.89f347f8.js"><link rel="prefetch" href="/assets/js/160.6963ee21.js"><link rel="prefetch" href="/assets/js/161.7791c848.js"><link rel="prefetch" href="/assets/js/162.11fe42ce.js"><link rel="prefetch" href="/assets/js/163.0c66bf87.js"><link rel="prefetch" href="/assets/js/164.a30af3f1.js"><link rel="prefetch" href="/assets/js/165.a2dd7427.js"><link rel="prefetch" href="/assets/js/166.46a29a8a.js"><link rel="prefetch" href="/assets/js/17.65a12e6d.js"><link rel="prefetch" href="/assets/js/18.861a0d7e.js"><link rel="prefetch" href="/assets/js/19.3052a24b.js"><link rel="prefetch" href="/assets/js/20.3cd0460e.js"><link rel="prefetch" href="/assets/js/21.986dcc58.js"><link rel="prefetch" href="/assets/js/22.fd63bbf4.js"><link rel="prefetch" href="/assets/js/23.56bfca5f.js"><link rel="prefetch" href="/assets/js/24.4973ba94.js"><link rel="prefetch" href="/assets/js/25.c6f0fdbf.js"><link rel="prefetch" href="/assets/js/26.0dcc4c64.js"><link rel="prefetch" href="/assets/js/27.cfca1ea4.js"><link rel="prefetch" href="/assets/js/28.cf552542.js"><link rel="prefetch" href="/assets/js/29.8a5d5ce1.js"><link rel="prefetch" href="/assets/js/3.218b5a9f.js"><link rel="prefetch" href="/assets/js/30.85595d28.js"><link rel="prefetch" href="/assets/js/31.c0be8130.js"><link rel="prefetch" href="/assets/js/32.f409392c.js"><link rel="prefetch" href="/assets/js/33.81c88a0f.js"><link rel="prefetch" href="/assets/js/34.44ecbb62.js"><link rel="prefetch" href="/assets/js/35.06b5bce5.js"><link rel="prefetch" href="/assets/js/36.4346d5b2.js"><link rel="prefetch" href="/assets/js/37.2ba34693.js"><link rel="prefetch" href="/assets/js/38.1e082286.js"><link rel="prefetch" href="/assets/js/39.05459d0a.js"><link rel="prefetch" href="/assets/js/4.2004d87a.js"><link rel="prefetch" href="/assets/js/40.fcfa58b7.js"><link rel="prefetch" href="/assets/js/41.a1291a3d.js"><link rel="prefetch" href="/assets/js/42.287bafa4.js"><link rel="prefetch" href="/assets/js/43.88f41841.js"><link rel="prefetch" href="/assets/js/44.d1169d63.js"><link rel="prefetch" href="/assets/js/45.a7202327.js"><link rel="prefetch" href="/assets/js/46.9e4df0d0.js"><link rel="prefetch" href="/assets/js/47.a520ca5c.js"><link rel="prefetch" href="/assets/js/48.990f1f9e.js"><link rel="prefetch" href="/assets/js/49.7af63144.js"><link rel="prefetch" href="/assets/js/5.08335bf0.js"><link rel="prefetch" href="/assets/js/50.f884fe7f.js"><link rel="prefetch" href="/assets/js/51.3cf6385a.js"><link rel="prefetch" href="/assets/js/52.2267e0fa.js"><link rel="prefetch" href="/assets/js/53.8928f89b.js"><link rel="prefetch" href="/assets/js/54.eec6f98b.js"><link rel="prefetch" href="/assets/js/55.8b8d18bf.js"><link rel="prefetch" href="/assets/js/56.a53e3fb0.js"><link rel="prefetch" href="/assets/js/57.9b8eb89e.js"><link rel="prefetch" href="/assets/js/58.71412cdb.js"><link rel="prefetch" href="/assets/js/59.47a6026a.js"><link rel="prefetch" href="/assets/js/6.dc32c23c.js"><link rel="prefetch" href="/assets/js/60.b445584e.js"><link rel="prefetch" href="/assets/js/61.92801308.js"><link rel="prefetch" href="/assets/js/62.0052829c.js"><link rel="prefetch" href="/assets/js/63.2521b7a9.js"><link rel="prefetch" href="/assets/js/64.6b9340b0.js"><link rel="prefetch" href="/assets/js/65.15dad725.js"><link rel="prefetch" href="/assets/js/66.ffb8e48f.js"><link rel="prefetch" href="/assets/js/67.723c5735.js"><link rel="prefetch" href="/assets/js/68.9764e00f.js"><link rel="prefetch" href="/assets/js/69.8ca37e49.js"><link rel="prefetch" href="/assets/js/7.6daaeea3.js"><link rel="prefetch" href="/assets/js/70.e42cb6da.js"><link rel="prefetch" href="/assets/js/71.409dee48.js"><link rel="prefetch" href="/assets/js/72.1ab12912.js"><link rel="prefetch" href="/assets/js/73.676fc788.js"><link rel="prefetch" href="/assets/js/74.92685b53.js"><link rel="prefetch" href="/assets/js/75.d522dd9a.js"><link rel="prefetch" href="/assets/js/76.c7b2b720.js"><link rel="prefetch" href="/assets/js/77.80df0aad.js"><link rel="prefetch" href="/assets/js/78.5fd278de.js"><link rel="prefetch" href="/assets/js/79.12c04eac.js"><link rel="prefetch" href="/assets/js/8.78bd4808.js"><link rel="prefetch" href="/assets/js/80.80a39d61.js"><link rel="prefetch" href="/assets/js/81.712b2fa8.js"><link rel="prefetch" href="/assets/js/82.e5cd6f26.js"><link rel="prefetch" href="/assets/js/83.42470a99.js"><link rel="prefetch" href="/assets/js/84.a6f17fa7.js"><link rel="prefetch" href="/assets/js/85.e35c6c1d.js"><link rel="prefetch" href="/assets/js/86.5ffa764c.js"><link rel="prefetch" href="/assets/js/87.adf840fb.js"><link rel="prefetch" href="/assets/js/88.2da0bac7.js"><link rel="prefetch" href="/assets/js/89.e816d413.js"><link rel="prefetch" href="/assets/js/9.f15b212e.js"><link rel="prefetch" href="/assets/js/90.b67499e3.js"><link rel="prefetch" href="/assets/js/91.70c4935e.js"><link rel="prefetch" href="/assets/js/92.49396136.js"><link rel="prefetch" href="/assets/js/93.5955e6ff.js"><link rel="prefetch" href="/assets/js/94.f2b5d6fa.js"><link rel="prefetch" href="/assets/js/95.639406b9.js"><link rel="prefetch" href="/assets/js/96.e3b8d160.js"><link rel="prefetch" href="/assets/js/97.68521a26.js"><link rel="prefetch" href="/assets/js/98.8a5369cc.js"><link rel="prefetch" href="/assets/js/99.9884a676.js">
    <link rel="stylesheet" href="/assets/css/0.styles.94a75534.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">叶良辰の学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/guide/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/zh/spring/" class="nav-link router-link-active">源码笔记</a></div><div class="nav-item"><a href="/zh/ludi/" class="nav-link">微服务笔记</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">Java面试题</a></div><div class="nav-item"><a href="/zh/write/" class="nav-link">手写框架</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>分布式应用</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nacos
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Sentinel
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://gitee.com/mirrors/Spring-Cloud-Alibaba" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SpringCloud Alibaba
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.elasticsearch.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ElasticSearch
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://skywalking.apache.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SkyWalking
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.keycloak.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Keycloak
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.sonarqube.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SonarQube
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>分布式事务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Seata
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.txlcn.org/zh-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TX-LCN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  XXL-JOB
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>分布式数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/zh/spring/ https://pingcap.com/docs-cn/" class="nav-link">TiDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">在线工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>在线编辑</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://cron.qqe2.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CRON 表达式
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.diffchecker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Diffchecker 比较工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://smallpdf.com/cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF&lt;互转&gt;Word
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.bejson.com/jsoneditoronline" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JSON在线编辑
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.processon.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Processon在线画图
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.i2symbol.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在线符号大全
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://tableconvert.com/?output=text" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown表格生成
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.toyaml.com/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  YAML&lt;互转&gt;Properties
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线答题</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://leetcode-cn.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  力扣
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.nowcoder.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  牛客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.lintcode.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LintCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线翻译</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://fanyi.youdao.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  有道翻译
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://translate.google.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  谷歌翻译
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线转POJO</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://java.bejson.com/generator/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SQL自动生成POJO
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.bejson.com/json2javapojo/new/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JSON自动生成POJO
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线验签</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://qy.weixin.qq.com/cgi-bin/debug" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信企业号接口调试工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信支付接口签名校验工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/debug" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信公众平台接口调试工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://pay.weixin.qq.com/wiki/tools/signverify/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信公众平台支付接口调试
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://docs.open.alipay.com/399" target="_blank" rel="noopener noreferrer" class="nav-link external">
  支付宝开发商文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://wiki.open.qq.com/wiki/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯开放平台
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="/zh/aboutme.html" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/guide/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/zh/spring/" class="nav-link router-link-active">源码笔记</a></div><div class="nav-item"><a href="/zh/ludi/" class="nav-link">微服务笔记</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">Java面试题</a></div><div class="nav-item"><a href="/zh/write/" class="nav-link">手写框架</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>分布式应用</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nacos
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Sentinel
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://gitee.com/mirrors/Spring-Cloud-Alibaba" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SpringCloud Alibaba
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.elasticsearch.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ElasticSearch
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://skywalking.apache.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SkyWalking
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.keycloak.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Keycloak
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.sonarqube.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SonarQube
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>分布式事务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Seata
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.txlcn.org/zh-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TX-LCN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  XXL-JOB
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>分布式数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/zh/spring/ https://pingcap.com/docs-cn/" class="nav-link">TiDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">在线工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>在线编辑</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://cron.qqe2.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CRON 表达式
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.diffchecker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Diffchecker 比较工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://smallpdf.com/cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF&lt;互转&gt;Word
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.bejson.com/jsoneditoronline" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JSON在线编辑
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.processon.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Processon在线画图
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.i2symbol.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在线符号大全
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://tableconvert.com/?output=text" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown表格生成
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.toyaml.com/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  YAML&lt;互转&gt;Properties
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线答题</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://leetcode-cn.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  力扣
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.nowcoder.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  牛客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.lintcode.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LintCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线翻译</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://fanyi.youdao.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  有道翻译
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://translate.google.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  谷歌翻译
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线转POJO</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://java.bejson.com/generator/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SQL自动生成POJO
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="http://www.bejson.com/json2javapojo/new/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JSON自动生成POJO
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>在线验签</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://qy.weixin.qq.com/cgi-bin/debug" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信企业号接口调试工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信支付接口签名校验工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/debug" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信公众平台接口调试工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://pay.weixin.qq.com/wiki/tools/signverify/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微信公众平台支付接口调试
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://docs.open.alipay.com/399" target="_blank" rel="noopener noreferrer" class="nav-link external">
  支付宝开发商文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://wiki.open.qq.com/wiki/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯开放平台
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="/zh/aboutme.html" class="nav-link">关于我</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring源码系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/spring/" class="sidebar-link">[一] Spring 源码学习简介</a></li><li><a href="/zh/spring/[2]Spring程序入口.html" class="sidebar-link">[二] Spring 程序入口和xml解析</a></li><li><a href="/zh/spring/[3]Spring初始化机制.html" class="sidebar-link">[三] Spring 初始化机制</a></li><li><a href="/zh/spring/[4]标签解析和bean实例化初探.html" class="sidebar-link">[四] Spring 容器Bean的实例化</a></li><li><a href="/zh/spring/[5]接口和bean的实例化第一步.html" class="sidebar-link">[五] Bean的实例化-后置处理器</a></li><li><a href="/zh/spring/[6]Bean的实例化和注解支持.html" class="sidebar-link">[六] Bean的实例化-注解支持</a></li><li><a href="/zh/spring/[7]循环依赖原理和Bean实例化流程梳理.html" class="sidebar-link">[七] Bean的实例化-循环依赖</a></li><li><a href="/zh/spring/[8]注解和bean的多例作用域.html" class="sidebar-link">[八] Bean的实例化-多例作用域</a></li><li><a href="/zh/spring/[9]Bean的销毁过程.html" class="sidebar-link">[九] Bean的实例化-Bean的销毁</a></li><li><a href="/zh/spring/[10]AOP链式调用过程和cglib动态代理.html" class="sidebar-link">[十] Spring AOP - ApectJ解析</a></li><li><a href="/zh/spring/[11]aop入口及aop中的各种advice和advisor.html" class="sidebar-link">[十一]Spring AOP - 代理入口类</a></li><li><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html" class="active sidebar-link">[十二] Spring的事务管理 - 声明式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html#spring的事务管理" class="sidebar-link">Spring的事务管理</a></li><li class="sidebar-sub-header"><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html#声明式事务管理" class="sidebar-link">声明式事务管理</a></li><li class="sidebar-sub-header"><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html#开启事务注解解析流程" class="sidebar-link">开启事务注解解析流程</a></li><li class="sidebar-sub-header"><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html#事务拦截器" class="sidebar-link">事务拦截器</a></li><li class="sidebar-sub-header"><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html#事务的实现过程" class="sidebar-link">事务的实现过程</a></li><li class="sidebar-sub-header"><a href="/zh/spring/[12]数据库事务和spring如何管理事务.html#事务问题汇总" class="sidebar-link">事务问题汇总</a></li></ul></li><li><a href="/zh/spring/[13]务隔离级别缓存切面和异步切面.html" class="sidebar-link">[十三] Spring的事务管理 - 编程式事务</a></li><li><a href="/zh/spring/[14]spring事务的传播属性和隔离级别源码讲解.html" class="sidebar-link">[十四] Spring的事务管理 - 隔离级别</a></li><li><a href="/zh/spring/[15]xml配置整合springmvc和嵌入式tomcat.html" class="sidebar-link">[十五] Spring MVC和嵌入式Tomcat</a></li><li><a href="/zh/spring/[16]springmvc请求响应核心调用流程和过滤器.html" class="sidebar-link">[十六] Spring MVC 核心调用流程</a></li><li><a href="/zh/spring/[17]特殊参数解析返回值解析视图渲染.html" class="sidebar-link">[十七] Spring MVC 核心调用流程-返回值解析</a></li><li><a href="/zh/spring/附：Spring容器加载核心方法简介.html" class="sidebar-link">附：Spring 中核心方法简介</a></li><li><a href="/zh/spring/附：自定义功能汇总.html" class="sidebar-link">附：Jack老师分享的甜点汇总</a></li><li><a href="/zh/spring/附：XML解析流程图.html" class="sidebar-link">附: Spring 中的流程图</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Mybatis源码系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/spring/Mybatis/" class="sidebar-link">[一] Mybatis 源码学习笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="十二-spring的事务管理-声明式事务"><a href="#十二-spring的事务管理-声明式事务" class="header-anchor">#</a> [十二] Spring的事务管理 - 声明式事务</h1> <h2 id="spring的事务管理"><a href="#spring的事务管理" class="header-anchor">#</a> Spring的事务管理</h2> <div class="tip custom-block"><p class="custom-block-title">导读</p> <p>在Spring中，事务也是用 AOP 切面技术来实现的，有两种实现方式：</p> <ul><li><ol><li><strong>声明式事务管理：</strong> 基于<code>Spring AOP</code>实现。其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，在执行完目标方法之后根据执行情况提交或者回滚事务。</li></ol></li> <li><ol start="2"><li><strong>编程式事务管理：</strong> 编程式事务管理使用<code>TransactionTemplate</code>可实现更细粒度的事务控制。</li></ol></li></ul> <p>声明式事务管理不需要入侵代码，通过<code>@Transactional</code>就可以进行事务操作，更快捷而且简单且大部分业务都可以满足，推荐使用。</p> <p>其实不管是编程式事务还是声明式事务，最终调用的底层核心代码是一致的。</p></div> <h2 id="声明式事务管理"><a href="#声明式事务管理" class="header-anchor">#</a> 声明式事务管理</h2> <p>1、 首先创建一个配置类，通过<code>@EnableTransactionManagement</code>开启事务管理功能</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.xiangxue.jack.dao&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>annotationClass <span class="token operator">=</span> <span class="token class-name">Repository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnableTransactionManagementBean</span> <span class="token punctuation">{</span>

   <span class="token comment">/*
    *  以下两个@Bean的配置都可以设置数据源
    *  通过SqlSessionFactoryBean设置数据源
    */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactoryBean</span> <span class="token function">sqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SqlSessionFactoryBean</span> sqlSessionFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token comment">/*
    *  通过事务管理平台的方式设置数据源
    */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token function">annotationDrivenTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataSourceTransactionManager</span> dtm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dtm<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dtm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>2、定义数据源</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:config/core/core.properties&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${jdbc.driverClassName}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> driverClass<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${jdbc.url:jdbc}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> jdbcUrl<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${jdbc.username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> user<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${jdbc.password}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">comboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ComboPooledDataSource</span> comboPooledDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setDriverClass</span><span class="token punctuation">(</span>driverClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setJdbcUrl</span><span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setMinPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setMaxIdleTime</span><span class="token punctuation">(</span><span class="token number">1800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setAcquireIncrement</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setMaxStatements</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setInitialPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setIdleConnectionTestPeriod</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setAcquireRetryAttempts</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setBreakAfterAcquireFailure</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setTestConnectionOnCheckout</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comboPooledDataSource<span class="token punctuation">.</span><span class="token function">setAcquireRetryDelay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PropertyVetoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> comboPooledDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>jdbc.driverClassName = org.gjt.mm.mysql.Driver
jdbc.url = jdbc:mysql://127.0.0.1:3306/consult
jdbc.username = root
jdbc.password = 123456
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">知识点</p> <p>数据源和事务管理平台的加载都是在类<code>ProxyTransactionManagementConfiguration</code>中进行的。Spring中的事务就是由 <code>connection</code>对象控制的，所以<code>connection</code>对象是和事务是绑定的，然后用户请求过来时又需要数据库连接来执行 sql 语句， 所以用户请求线程又是跟 <code>connection</code> 是绑定的。</p></div> <h2 id="开启事务注解解析流程"><a href="#开启事务注解解析流程" class="header-anchor">#</a> 开启事务注解解析流程</h2> <blockquote><p>首先看以下<code>@EnableTransactionManagement</code>注解的源码</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">TransactionManagementConfigurationSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableTransactionManagement</span> <span class="token punctuation">{</span>
	<span class="token comment">// proxyTargetClass = false 表示是JDK动态代理支持接口代理。</span>
	<span class="token comment">// true表示是Cglib代理支持子类继承代理。</span>
	<span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token comment">// 事务通知模式(切面织入方式)，默认代理模式（同一个类中方法互相调用拦截器不会生效）</span>
	<span class="token class-name">AdviceMode</span> <span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span>PROXY<span class="token punctuation">;</span>
	<span class="token comment">// 连接点上有多个通知时，排序，默认最低。值越大优先级越低。</span>
	<span class="token keyword">int</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span>LOWEST_PRECEDENCE<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>TransactionManagementConfigurationSelector</code>类</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionManagementConfigurationSelector</span> <span class="token keyword">extends</span> <span class="token class-name">AdviceModeImportSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnableTransactionManagement</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AdviceMode</span> adviceMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/**
		 *  TODO : 导入需要加载的类
		 *  1、AutoProxyRegistrar: 给容器中注册一个InfrastructureAdvisorAutoProxyCreator(Spring事务入口类) 组件；
		 *  利用后置处理器机制在对象创建以后，包装对象，返回一个代理对象（增强器），
		 *  代理对象执行方法利用拦截器链进行调用；
		 *
		 *  2、ProxyTransactionManagementConfiguration: 就是一个配置类，定义了事务增强器、拦截器。
		 *
		 */</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>adviceMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> PROXY<span class="token operator">:</span>
				<span class="token comment">// 重点看这2个类：</span>
				<span class="token comment">// AutoProxyRegistrar</span>
				<span class="token comment">// ProxyTransactionManagementConfiguration</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">AutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						<span class="token class-name">ProxyTransactionManagementConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ASPECTJ<span class="token operator">:</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token function">determineTransactionAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">determineTransactionAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token string">&quot;javax.transaction.Transactional&quot;</span><span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
				<span class="token class-name">TransactionManagementConfigUtils</span><span class="token punctuation">.</span>JTA_TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME <span class="token operator">:</span>
				<span class="token class-name">TransactionManagementConfigUtils</span><span class="token punctuation">.</span>TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>那么这个<code>@EnableTransactionManagement</code>开启事务管理配置的注解是如何被调用的呢？我们回顾一下<code>Spring的初始化核心流程</code></p></blockquote> <h3 id="spring-初始化核心流程回顾"><a href="#spring-初始化核心流程回顾" class="header-anchor">#</a> Spring 初始化核心流程回顾</h3> <blockquote><p>spring容器初始化的核心方法AbstractApplicationContext#refresh ，</p></blockquote> <ul><li><code>├─</code> refresh <span class="badge warning" style="vertical-align:top;" data-v-c13ee5b0>Spring 初始化核心流程入口</span></li> <li><code>│ ├─</code> prepareRefresh <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>① 准备此上下文用于刷新，设置启动时间和active标志，初始化属性</span></li> <li><code>│ ├─</code> obtainFreshBeanFactory  <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>② 创建 BeanFactory</span></li> <li><code>│ ├─</code> prepareBeanFactory <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>③ 设置 BeanFactory 的基本属性</span></li> <li><code>│ ├─</code> postProcessBeanFactory  <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>④ 子类处理自定义的BeanFactoryPostProcess</span></li> <li><code>│ ├─</code> <strong>invokeBeanFactoryPostProcessors</strong> <span class="badge error" style="vertical-align:top;" data-v-c13ee5b0>⑤ 开启事务管理配置的调用入口</span></li> <li><code>│ ├─</code> registerBeanPostProcessors <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑥ 注册拦截Bean创建的Bean处理器</span></li> <li><code>│ ├─</code> initMessageSource <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑦ 初始化上下文中的资源文件，如国际化文件的处理等</span></li> <li><code>│ ├─</code> initApplicationEventMulticaster <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑧ 初始化上下文的事件传播器</span></li> <li><code>│ ├─</code> onRefresh <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑨ 给子类扩展初始化其他Bean，springboot 中用来做内嵌 tomcat 启动</span></li> <li><code>│ ├─</code>  registerListeners <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑩  在所有bean中查找监听 bean，然后注册到广播器中</span></li> <li><code>│ ├─</code> finishBeanFactoryInitialization <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑪ 初始化所有的单例Bean、ioc、BeanPostProcessor的执行、Aop入口</span></li> <li><code>│ └─</code>  finishRefresh <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑫ 完成刷新过程，发布相应的事件</span></li></ul> <blockquote><p>进入<code>invokeBeanFactoryPostProcessors()</code> 方法</p> <p>类文件： org.springframework.beans.factory.support.<code>AbstractApplicationContext</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 看这个 invokeBeanFactoryPostProcessors 方法</span>
<span class="token class-name">PostProcessorRegistrationDelegate</span><span class="token punctuation">.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token function">getBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getTempClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>invokeBeanFactoryPostProcessors()</code> 方法</p> <p>类文件：  org.springframework.beans.factory.support.<code>PostProcessorRegistrationDelegate</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>
			<span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">&gt;</span></span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			
   <span class="token comment">/** ...... 省略 ......  **/</span>
   <span class="token comment">/**
    * 调用过程
    * 在这里典型的 BeanDefinitionRegistryPostProcessor 就是 ConfigurationClassPostProcessor
    * 用于进行bean定义的加载 比如我们的包扫描，@import等
    * @EnableAspectJAutoProxy 注解中的 AspectJAutoProxyRegistrar 类就是通过此方法调用执行
    * @EnableTransactionManagement 注解中的 TransactionManagementConfigurationSelector 类就是通过此方法调用执行
    */</span>
	<span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 调用完之后，马上clear</span>
	currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>invokeBeanDefinitionRegistryPostProcessors()</code> 方法</p> <p>类文件：  org.springframework.beans.factory.support.<code>PostProcessorRegistrationDelegate</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">&gt;</span></span> postProcessors<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 重点看这个方法</span>
			postProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>postProcessBeanDefinitionRegistry()</code> 方法</p> <p>所在类 org.springframework.context.annotation.<code>ConfigurationClassPostProcessor</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> registryId <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 重点看这个方法</span>
		<span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">知识点</p> <p><code>ConfigurationClassPostProcessor</code>类非常重要，此类是对Spring容器中所有的<code>BeanDefinition</code>的新增、修改等操作，也就是说对<code>BeanDefinition</code>的增删查改都会在<code>ConfigurationClassPostProcessor</code>类中进行。同时还支持了@Import、@ImportResource、@ComponetScan、@Configruration等注解的解析工作。</p></div> <blockquote><p>进入<code>processConfigBeanDefinitions()</code> 方法，这个时候<code>bean</code>还没有实例化</p> <p>类文件：  org.springframework.beans.factory.support.<code>ConfigurationClassPostProcessor</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token comment">/** ...... 省略 ......  **/</span>
	<span class="token keyword">do</span> <span class="token punctuation">{</span>
			<span class="token comment">// 进入parse方法</span>
			parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
			parser<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>接下来的调用的过程较为繁琐，此处省略无关的源码，按照如下步骤自行跟踪源码即可</p> <p>进入<code>parse</code>方法，</p> <p>进入子<code>parse</code>方法，</p> <p>进入<code>processConfigurationClass</code>方法，</p> <p>进入<code>doProcessConfigurationClass</code>方法，</p> <p>最后进入<code>processImports</code> 方法，</p> <p>类文件：  org.springframework.beans.factory.support.<code>ConfigurationClassParser</code>
到此处，<code>selectImports()</code>方法最终会被<code>ConfigurationClassParser</code>类的<code>processImports()</code>方法调用执行，具体见第<code>ConfigurationClassParser</code>类的第<code>569</code>行，</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processImports</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> currentSourceClass<span class="token punctuation">,</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceClass</span><span class="token punctuation">&gt;</span></span> importCandidates<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkForCircularImports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token comment">/** ...... 省略 ......  **/</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token class-name">ImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidateClass <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 反射拿到 ImportSelector 接口类的实例化对象 selector</span>
	<span class="token class-name">ImportSelector</span> selector <span class="token operator">=</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>candidateClass<span class="token punctuation">,</span> <span class="token class-name">ImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ParserStrategyUtils</span><span class="token punctuation">.</span><span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>
			selector<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token keyword">instanceof</span> <span class="token class-name">DeferredImportSelector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>deferredImportSelectorHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>
				configClass<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">DeferredImportSelector</span><span class="token punctuation">)</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">/*
	 * 然后通过 selector调用其实现类 AdviceModeImportSelector
	 * 的selectImports方法，模板中的钩子方法。最后拿到返回的
	 * TransactionManagementConfigurationSelector的selectImports
	 * 方法返回的两个类：
	 *  1、AutoProxyRegistrar.class
	 *  2、ProxyTransactionManagementConfiguration.class
     *  继续递归调用当前的 processImports 方法
     */</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> importClassNames <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectImports</span><span class="token punctuation">(</span>currentSourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceClass</span><span class="token punctuation">&gt;</span></span> importSourceClasses <span class="token operator">=</span> <span class="token function">asSourceClasses</span><span class="token punctuation">(</span>importClassNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">processImports</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> currentSourceClass<span class="token punctuation">,</span> importSourceClasses<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="开启事务的入口类"><a href="#开启事务的入口类" class="header-anchor">#</a> 开启事务的入口类</h3> <blockquote><p>进入<code>selectImports()</code>方法，找到其实现类<code>AdviceModeImportSelector</code>的<code>selectImports</code>方法</p> <p>类文件： org.springframework.context.annotation.<code>AdviceModeImportSelector</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> annType <span class="token operator">=</span> <span class="token class-name">GenericTypeResolver</span><span class="token punctuation">.</span><span class="token function">resolveTypeArgument</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">AdviceModeImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>annType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Unresolvable type argument for AdviceModeImportSelector&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">AnnotationAttributes</span> attributes <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> annType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
					<span class="token string">&quot;@%s is not present on importing class '%s' as expected&quot;</span><span class="token punctuation">,</span>
					annType<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importingClassMetadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">AdviceMode</span> adviceMode <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token function">getAdviceModeAttributeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 此方法最终会调用TransactionManagementConfigurationSelector</span>
		<span class="token comment">// 的 selectImports方法</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> imports <span class="token operator">=</span> <span class="token function">selectImports</span><span class="token punctuation">(</span>adviceMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>imports <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown AdviceMode: &quot;</span> <span class="token operator">+</span> adviceMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> imports<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>调回到<code>selectImports</code>方法后，会把<code>AutoProxyRegistrar</code>和<code>ProxyTransactionManagementConfiguration</code>两个类注册到<code>Beandefinition</code>中</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionManagementConfigurationSelector</span> <span class="token keyword">extends</span> <span class="token class-name">AdviceModeImportSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnableTransactionManagement</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AdviceMode</span> adviceMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/**
		 *  TODO : 导入需要加载的类
		 *  1、AutoProxyRegistrar: 给容器中注册一个InfrastructureAdvisorAutoProxyCreator 组件；
		 *  利用后置处理器机制在对象创建以后，包装对象，返回一个代理对象（增强器），
		 *  代理对象执行方法利用拦截器链进行调用；
		 *
		 *  2、ProxyTransactionManagementConfiguration: 就是一个配置类，定义了事务增强器、拦截器。
		 *
		 */</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>adviceMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> PROXY<span class="token operator">:</span>
				<span class="token comment">// 重点看这2个类：</span>
				<span class="token comment">// AutoProxyRegistrar</span>
				<span class="token comment">// ProxyTransactionManagementConfiguration</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">AutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						<span class="token class-name">ProxyTransactionManagementConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ASPECTJ<span class="token operator">:</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token function">determineTransactionAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="事务核心类-autoproxyregistrar-源码"><a href="#事务核心类-autoproxyregistrar-源码" class="header-anchor">#</a> 事务核心类 - AutoProxyRegistrar 源码</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">boolean</span> candidateFound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// 循环遍历导入类上使用的所有注解（主要处理注解中有 mode和 proxyTargetClass属性的）</span>
		<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> annoTypes <span class="token operator">=</span> importingClassMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> annoType <span class="token operator">:</span> annoTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">AnnotationAttributes</span> candidate <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> annoType<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 获取注解中的 mode 属性</span>
			<span class="token class-name">Object</span> mode <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 获取注解中的 proxyTargetClass 属性</span>
			<span class="token class-name">Object</span> proxyTargetClass <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;proxyTargetClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> proxyTargetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> mode<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
					<span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> proxyTargetClass<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				candidateFound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token comment">// 如果 mode 是代理模式</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span>PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// 注册事务AOP的入口类 InfrastructureAdvisorAutoProxyCreator,实际上这个AOP入口类起不了作用</span>
					<span class="token class-name">AopConfigUtils</span><span class="token punctuation">.</span><span class="token function">registerAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> proxyTargetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">AopConfigUtils</span><span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="事务核心类-proxytransactionmanagementconfiguration-源码"><a href="#事务核心类-proxytransactionmanagementconfiguration-源码" class="header-anchor">#</a> 事务核心类 - ProxyTransactionManagementConfiguration 源码</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyTransactionManagementConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTransactionManagementConfiguration</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">TransactionManagementConfigUtils</span><span class="token punctuation">.</span>TRANSACTION_ADVISOR_BEAN_NAME<span class="token punctuation">)</span>
	<span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
	<span class="token comment">//</span>
	<span class="token comment">/**
	 * TODO : 定义事务增强器(事务织入)
	 *
	 * 定义了一个 advisor，设置事务属性、设置事务拦截器 TransactionInterceptor、设置顺序。
	 * 核心就是事务拦截器 TransactionInterceptor。
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span> <span class="token function">transactionAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span> advisor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		advisor<span class="token punctuation">.</span><span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		advisor<span class="token punctuation">.</span><span class="token function">setAdvice</span><span class="token punctuation">(</span><span class="token function">transactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			advisor<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> advisor<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
	<span class="token comment">// 主要负责解析 @Transactional注解里的属性资源</span>
	<span class="token comment">// 并包装为 TransactionAttribute 类型</span>
	<span class="token keyword">public</span> <span class="token class-name">TransactionAttributeSource</span> <span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
	<span class="token comment">// 定义事务拦截器</span>
	<span class="token keyword">public</span> <span class="token class-name">TransactionInterceptor</span> <span class="token function">transactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// TransactionInterceptor 实现了 MethodInterceptor 接口，</span>
		<span class="token comment">// 在链式调用中会自动调用它的 invoke 方法</span>
		<span class="token class-name">TransactionInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 设置 TransactionAttribute 属性</span>
		interceptor<span class="token punctuation">.</span><span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 如果当前事务管理器不为空，设置当前事务管理器到拦截器中</span>
		<span class="token comment">// 事务管理器和数据源绑定，此处可以自定义</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			interceptor<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">知识点</p> <p>此处可以参考父类<code>AbstractTransactionManagementConfiguration</code>中的<code>setConfigurers</code>方法，通过重写<code>TransactionManagementConfigurer</code>的<code>annotationDrivenTransactionManager</code>方法来自定义一个事务管理器。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionManagementConfigurerBean</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionManagementConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token function">annotationDrivenTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataSourceTransactionManager</span> dtm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dtm<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dtm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <blockquote><p>到此为止，Spring中<code>@EnableTransactionManagement</code>注解的内部注册解析的准备工作完成。</p></blockquote> <h2 id="事务拦截器"><a href="#事务拦截器" class="header-anchor">#</a> 事务拦截器</h2> <div class="tip custom-block"><p class="custom-block-title">TransactionInterceptor</p> <p>Spring声明式事物是基于AOP实现的，如果目标方法存在事物则会对目标对象进行增强代理(JDK/Cglib)。而<code>TransactionInterceptor</code>则是事物体系中的增强器(Advise)，它实现了<code>MethodInterceptor</code>接口，<code>TransactionInterceptor</code>会被封装在使用了事务注解<code>@Transactional</code>的bean组件外面形成该组件的代理对象，当调用相应使用事务注解的方法时，<code>TransactionInterceptor</code>的<code>invoke</code>方法拦截器逻辑会被调用执行，从而完成相应的事务管理，包括：创建、提交和回滚等底层操作。</p></div> <h3 id="spring-事务拦截处理流程"><a href="#spring-事务拦截处理流程" class="header-anchor">#</a> Spring 事务拦截处理流程</h3> <blockquote><p>spring事务拦截器解析流程<code>TransactionInterceptor</code>#<code>invoke</code> ，</p></blockquote> <ul><li><code>├─</code> invoke <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>Spring 事务拦截器入口</span></li> <li><code>├─</code> invokeWithinTransaction <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>调用Spring内部事务</span></li> <li><code>│ ├─</code> getTransactionAttributeSource <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>① 通过事务属性源读取事务的属性配置</span></li> <li><code>│ ├─</code> getTransactionAttribute  <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>② 获取该方法的事务属性(传播机制、隔离级别)</span></li> <li><code>│ ├─</code> <strong>determineTransactionManager</strong> <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>③ 查找容器中的PlatformTransactionManager，用于管理事务</span></li> <li><code>│ ├─</code> methodIdentification  <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>④ 获取被代理的类方法名称</span></li> <li><code>│ ├─</code> createTransactionIfNecessary  <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑤ 创建事务并保存到TransactionInfo</span> <span class="badge error" style="vertical-align:top;" data-v-c13ee5b0>声明式事务</span></li> <li><code>│ ├─</code> proceedWithInvocation <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑥ 火炬传递方法，拦截器链调用处理</span></li> <li><code>│ ├─</code> completeTransactionAfterThrowing <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑦ 执行业务报错，回滚事务</span></li> <li><code>│ ├─</code> cleanupTransactionInfo <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑧ 清空当前事务信息，重置为老的</span></li> <li><code>│ ├─</code> commitTransactionAfterReturning <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑨ 返回结果之前提交事务</span></li> <li><code>│ ├─</code> <strong>execute</strong> <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>①   执行实现TransactionCallback接口的doInTransaction回调方法</span> <span class="badge error" style="vertical-align:top;" data-v-c13ee5b0>编程式事务</span></li> <li><code>│ │ ├─</code> prepareTransactionInfo <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>② 准备事务信息</span></li> <li><code>│ │ │ ├─</code> new TransactionInfo <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>③ 创建事务信息对象</span></li> <li><code>│ │ │ ├─</code> newTransactionStatus <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>④ 为事务信息对象设置事务状态</span></li> <li><code>│ │ │ └─</code> bindToThread <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑤ 把创建的事务信息对象和线程绑定到TreadLocal</span></li> <li><code>│ │ ├─</code> proceedWithInvocation <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑥ 火炬传递方法， 拦截器链调用处理</span></li> <li><code>│ │ ├─</code> rollbackOn <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑦ 事务是否满足对异常进行回滚处理条件</span></li> <li><code>│ │ └─</code> cleanupTransactionInfo <span class="badge danger" style="vertical-align:top;" data-v-c13ee5b0>⑧ 初始化所有的单例Bean、ioc、BeanPostProcessor的执行、Aop入口</span></li></ul> <blockquote><p>进入<code>invoke</code> 方法，</p> <p>类文件： org.springframework.transaction.interceptor.<code>TransactionInterceptor</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token comment">/**
	 *  TODO : 事务拦截器的拦截方法
	 * 事务拦截器TransactionInterceptor回调方法invoke通过调用TransactionAspectSupport事务切面支持类中的
	 * createTransactionIfNecessary和prepareTransactionInfo方法创建事务对象
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
		<span class="token comment">// Work out the target class: may be {@code null}.</span>
		<span class="token comment">// The TransactionAttributeSource should be passed the target class</span>
		<span class="token comment">// as well as the method, which may be from an interface.</span>
		<span class="token comment">// 通过 AOP获取事务的目标类</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Adapt to TransactionAspectSupport's invokeWithinTransaction...</span>
		<span class="token comment">// 核心方法，调用内部事务处理，实际调用父类 TransactionAspectSupport的 invokeWithinTransaction方法</span>
		<span class="token keyword">return</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> invocation<span class="token operator">:</span><span class="token operator">:</span><span class="token function">proceed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>invokeWithinTransaction</code> 方法，父类中实现</p> <p>类文件： org.springframework.transaction.interceptor.<code>TransactionAspectSupport</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * TODO : 调用内部事务
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span>
			<span class="token keyword">final</span> <span class="token class-name">InvocationCallback</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

		<span class="token comment">// If the transaction attribute is null, the method is non-transactional.</span>
		<span class="token comment">// 通过事务属性源 TransactionAttributeSource读取事务的属性配置（名称匹配）</span>
		<span class="token class-name">TransactionAttributeSource</span> tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取对应事务属性.如果事务属性为空（则目标方法不存在事务）</span>
		<span class="token comment">// 事务属性源 NameMatchTransactionAttributeSource 的方法</span>
		<span class="token keyword">final</span> <span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token punctuation">(</span>tas <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> tas<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 根据事务的属性获取 beanFactory 中的 PlatformTransactionManager (spring事务管理器的顶级接口)，</span>
		<span class="token comment">// 获取 Spring事务管理IoC容器配置的事务处理器</span>
		<span class="token comment">// 一般常用实现是 DataSourceTransactiuonManager</span>
		<span class="token keyword">final</span> <span class="token class-name">PlatformTransactionManager</span> tm <span class="token operator">=</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 目标方法唯一标识（类.方法，如service.ServiceImpl.add）</span>
		<span class="token comment">// 获取目标类指定方法的事务连接点</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification <span class="token operator">=</span> <span class="token function">methodIdentification</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/*
		 * 区分不同类型的 PlatformTransactionManager事务处理器，不同类型的事务处理器调用方式不同。对
		 * CallbackPreferringPlatformTransactionManager，需要回调函数来实现事务的创建和提交，对非
		 * CallbackPreferringPlatformTransactionManager来说，则不需要使用回调函数来实现事务处理。
		 */</span>
		<span class="token comment">// 如果txAttr为空或者tm 属于非CallbackPreferringPlatformTransactionManager类型的事务处理器</span>
		<span class="token comment">// 声明式事务的操作</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>tm <span class="token keyword">instanceof</span> <span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span>
			<span class="token comment">// 使用 getTransaction 和 提交/回滚 调用的标准事务划分。</span>
			<span class="token comment">// 创建事务，将当前事务状态和信息保存到TransactionInfo对象中，重要</span>
			<span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Object</span> retVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token comment">// This is an around advice: Invoke the next interceptor in the chain.</span>
				<span class="token comment">// This will normally result in a target object being invoked.</span>
				<span class="token comment">// 这里就是一个环绕增强，在这个proceed前后可以自己定义增强实现。</span>
				<span class="token comment">// 回调方法执行，执行目标方法（原有的业务逻辑）</span>
				retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// target invocation exception</span>
				<span class="token comment">// 根据事务定义的，该异常需要回滚就回滚，否则提交事务</span>
				<span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">finally</span> <span class="token punctuation">{</span>
				<span class="token comment">// 清空当前事务信息，重置为老的</span>
				<span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 返回结果之前提交事务</span>
			<span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 编程式事务</span>
		<span class="token comment">// CallbackPreferringPlatformTransactionManager类型的事务处理器</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token class-name">ThrowableHolder</span> throwableHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// It's a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token comment">// 执行实现T ransactionCallback 接口的 doInTransaction 回调方法</span>
				<span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span> tm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">,</span> status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
					<span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token comment">// 拦截器链调用处理，使得最后目标对象的方法得到调用</span>
						<span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// 如果事务满足对异常进行回滚处理条件</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr<span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// A RuntimeException: will lead to a rollback.</span>
							<span class="token comment">// 如果异常是运行时异常，则事务回滚处理</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token comment">//如果不是运行时异常，则提交处理</span>
							<span class="token keyword">else</span> <span class="token punctuation">{</span>
								<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableHolderException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token comment">// A normal return value: will lead to a commit.</span>
							<span class="token comment">// 提交处理</span>
							throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">=</span> ex<span class="token punctuation">;</span>
							<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token comment">//清除当前线程绑定的事务信息</span>
					<span class="token keyword">finally</span> <span class="token punctuation">{</span>
						<span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 到这里都是execute方法</span>

				<span class="token comment">// Check result state: It might indicate a Throwable to rethrow.</span>
				<span class="token comment">// 如果是ThrowableHolder类型的异常，则转换为Throwable抛出，上抛异常</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">throw</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 否则异常不做处理直接抛出</span>
				<span class="token keyword">return</span> result<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ThrowableHolderException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
					ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>getTransactionAttribute</code> 方法，父类中实现</p> <p>类文件： org.springframework.transaction.interceptor.<code>AbstractFallbackTransactionAttributeSource</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 首先看是否存在缓存值</span>
		<span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">TransactionAttribute</span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attributeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 如果缓存的是一个无事务对象，直接返回 null</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">==</span> NULL_TRANSACTION_ATTRIBUTE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> cached<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 缓存中不存在</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 重新计算 TransactionAttribute 属性，根据方法和类的类型获取事务信息</span>
			<span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 存到缓存中</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>attributeCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> NULL_TRANSACTION_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> methodIdentification <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedMethodName</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token keyword">instanceof</span> <span class="token class-name">DefaultTransactionAttribute</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionAttribute</span><span class="token punctuation">)</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDescriptor</span><span class="token punctuation">(</span>methodIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Adding transactional method '&quot;</span> <span class="token operator">+</span> methodIdentification <span class="token operator">+</span> <span class="token string">&quot;' with attribute: &quot;</span> <span class="token operator">+</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 将事务对象属性放到缓存中，缓存的key与类的类型和方法相关</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>attributeCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>computeTransactionAttribute</code> 方法，父类中实现</p> <p>类文件： org.springframework.transaction.interceptor.<code>AbstractFallbackTransactionAttributeSource</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 如果被代理方法非public类型，则直接返回空，Spring事务不支持非public类型方法</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allowPublicMethodsOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 方法可能在接口上，但是我们需要目标类的属性。</span>
		<span class="token comment">// 如果目标类为空，则方法将保持不变。</span>
		<span class="token class-name">Method</span> specificMethod <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getMostSpecificMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// First try is the method in the target class.</span>
		<span class="token comment">// 解析方法上的 @Transactional 属性</span>
		<span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>specificMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Second try is the transaction attribute on the target class.</span>
		<span class="token comment">// 如果方法上没有事务属性，就从类上来获取</span>
		txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>specificMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isUserLevelMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>specificMethod <span class="token operator">!=</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Fallback is to look at the original method.</span>
			txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Last fallback is the class of the original method.</span>
			txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isUserLevelMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">知识点</p> <p>被代理方法是否是<code>public</code>类型，就是在<code>computeTransactionAttribute</code>这个方法中进行校验的，Spring中的事务只对<code>public</code>类型的方法起作用，<code>非public</code>类型事务失效。</p></div> <h3 id="transactional注解的解析"><a href="#transactional注解的解析" class="header-anchor">#</a> @Transactional注解的解析</h3> <blockquote><p>进入<code>findTransactionAttribute</code> 方法，</p> <p>进入<code>determineTransactionAttribute</code> 方法，</p> <p>进入<code>parseTransactionAnnotation</code> 方法，</p> <p>类文件： org.springframework.transaction.annotation.<code>SpringTransactionAnnotationParser</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * TODO : 解析事务注解中的属性
 */</span>
 <span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">RuleBasedTransactionAttribute</span> rbta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取事务传播属性</span>
		<span class="token class-name">Propagation</span> propagation <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;propagation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		rbta<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span>propagation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取事务隔离等级</span>
		<span class="token class-name">Isolation</span> isolation <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;isolation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		rbta<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span>isolation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取事务获取事务超时时间</span>
		rbta<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取事务是否只读</span>
		rbta<span class="token punctuation">.</span><span class="token function">setReadOnly</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;readOnly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取事务事务管理器 bean的名称</span>
		rbta<span class="token punctuation">.</span><span class="token function">setQualifier</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">&gt;</span></span> rollbackRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取事务回滚相关配置</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;rollbackFor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;rollbackForClassName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;noRollbackFor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;noRollbackForClassName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		rbta<span class="token punctuation">.</span><span class="token function">setRollbackRules</span><span class="token punctuation">(</span>rollbackRules<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> rbta<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>到此为止，@Transactional注解的加载工作也完成，注解的属性值已近被加载到spring容器中了，接下来开始具体的事务操作过程。</p></blockquote> <h2 id="事务的实现过程"><a href="#事务的实现过程" class="header-anchor">#</a> 事务的实现过程</h2> <blockquote><p>创建事务之前的准备工作已经完成了，那么具体事务是如何创建实现的呢？</p> <p>回到<code>invokeWithinTransaction</code>方法，</p> <p>进入<code>createTransactionIfNecessary</code> 方法，</p> <p>类文件： org.springframework.transaction.interceptor.<code>TransactionAspectSupport</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * TODO : 根据给定的事务属性创建事务对象
 */</span>
 <span class="token keyword">protected</span> <span class="token class-name">TransactionInfo</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PlatformTransactionManager</span> tm<span class="token punctuation">,</span>
			<span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionAttribute</span> txAttr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 如果没有指定名称，则应用方法标识作为事务名称。</span>
		<span class="token comment">// 读取事务方法调用的事务配置属性</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txAttr<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 如果事务名称为 null，则使用方法的名称(事务连接点标识)作为事务名称，</span>
			<span class="token comment">// 调用一个实现 DelegatingTransactionAttribute 接口的匿名内部类</span>
			txAttr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegatingTransactionAttribute</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token annotation punctuation">@Override</span>
				<span class="token comment">// 使用方法名称作为事务名称</span>
				<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> joinpointIdentification<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 事务状态封装了事务执行的状态信息</span>
		<span class="token class-name">TransactionStatus</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>tm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 事务处理器创建事务，并且返回当前事务的状态信息</span>
				<span class="token comment">// 核心方法，真正底层创建事务对象的方法</span>
				status <span class="token operator">=</span> tm<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping transactional joinpoint [&quot;</span> <span class="token operator">+</span> joinpointIdentification <span class="token operator">+</span>
							<span class="token string">&quot;] because no transaction manager has been configured&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 准备事务信息，事务信息 TransactionInfo 封装了事务配置和状态信息</span>
		<span class="token keyword">return</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>getTransaction</code> 方法，</p> <p>类文件： org.springframework.transaction.support.<code>AbstractPlatformTransactionManager</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
		<span class="token comment">// doGetTransaction()方法是抽象方法，具体的实现由具体的事务处理器提供</span>
		<span class="token class-name">Object</span> transaction <span class="token operator">=</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Cache debug flag to avoid repeated checks.</span>
		<span class="token keyword">boolean</span> debugEnabled <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 如果没有配置事务属性，则使用默认的事务属性</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Use defaults if no transaction definition given.</span>
			definition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 检查当前线程是否存在事务，如果已存在事务，那么需要根据在事务属性中定义的事务传播属性来处理事务的产生（检查传播行为）</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span>
			<span class="token comment">// 处理已存在的事务的情况</span>
			<span class="token keyword">return</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Check definition settings for new transaction.</span>
		<span class="token comment">// 检查事务属性中timeout超时属性设置是否合理</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>TIMEOUT_DEFAULT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid transaction timeout&quot;</span><span class="token punctuation">,</span> definition<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span>
		<span class="token comment">// 对事务属性中配置的事务传播特性处理</span>
		<span class="token comment">// 如果当前获取不到存在的事务，且事务传播特性配置的是 mandatory，当前没有事务存在，抛出异常</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_MANDATORY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;No existing transaction found for transaction marked with propagation 'mandatory'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 获取不到存在的事务，并且事务传播属性是 REQUIRED、REQUIRES_NEW、NESTED</span>
		<span class="token comment">// 则执行事务挂起，新建事务。</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRED <span class="token operator">||</span>
				definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRES_NEW <span class="token operator">||</span>
				definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NESTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 挂起当前事务</span>
			<span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating new transaction with name [&quot;</span> <span class="token operator">+</span> definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token comment">// 不激活和当前线程绑定的事务，因为事务传播特性配置要求创建新的事务</span>
				<span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> SYNCHRONIZATION_NEVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 创建一个新的事务状态</span>
				<span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
						definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 核心方法：创建事务的调用，具体实现由具体的事务处理器提供。</span>
				<span class="token comment">// 设置事务隔离级别（spring默认的事务隔离级别是跟JDBC相同的，即默认情况Spring不设置事务隔离级别）；</span>
				<span class="token function">doBegin</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 初始化和同步事务状态</span>
				<span class="token function">prepareSynchronization</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> status<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">resume</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_DEFAULT <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Custom isolation level specified but no actual transaction initiated; &quot;</span> <span class="token operator">+</span>
						<span class="token string">&quot;isolation level will effectively be ignored: &quot;</span> <span class="token operator">+</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 创建空事务，针对 supported 类型的事务传播特性，激活和当前线程绑定的事务</span>
			<span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SYNCHRONIZATION_ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 准备事务状态</span>
			<span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">知识点</p> <p>抽象事务管理器<code>AbstractPlatformTransactionManager</code>提供了创建事务的模板，这个模板会被具体的事
务处理器所使用，抽象事务管理器根据事务属性配置和当前线程绑定信息对事务是否需要创建以及如何创建进行一
些通用的处理，然后把事务创建的底层细节交给具体的事务处理器实现。</p></div> <blockquote><p>进入<code>doGetTransaction</code> 方法，由jdbc包下的数据源类实现</p> <p>类文件： org.springframework.jdbc.datasource.<code>DataSourceTransactionManager</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 管理 connection对象，创建回滚点，按照回滚点回滚，释放回滚点</span>
		<span class="token comment">// DataSourceTransactionObject 就是真正的事务对象</span>
		<span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// DataSourceTransactionManager 默认是允许嵌套事务的</span>
		txObject<span class="token punctuation">.</span><span class="token function">setSavepointAllowed</span><span class="token punctuation">(</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// obtainDataSource() 获取数据源对象，其实就是数据库连接对象</span>
		<span class="token comment">// ConnectionHolder 持有了 Connection，并对 Connection进行了包装</span>
		<span class="token class-name">ConnectionHolder</span> conHolder <span class="token operator">=</span>
				<span class="token punctuation">(</span><span class="token class-name">ConnectionHolder</span><span class="token punctuation">)</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span>conHolder<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> txObject<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>getResource</code>方法，</p> <p>类文件： org.springframework.transaction.support.<code>TransactionSynchronizationManager</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 查看数据源连接池有没有扩展，一般没有</span>
		<span class="token class-name">Object</span> actualKey <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationUtils</span><span class="token punctuation">.</span><span class="token function">unwrapResourceIfNecessary</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token function">doGetResource</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Retrieved value [&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;] for key [&quot;</span> <span class="token operator">+</span> actualKey <span class="token operator">+</span> <span class="token string">&quot;] bound to thread [&quot;</span> <span class="token operator">+</span>
					<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>进入<code>doGetResource</code>方法，</p> <p>类文件： org.springframework.transaction.support.<code>TransactionSynchronizationManager</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">doGetResource</span><span class="token punctuation">(</span><span class="token class-name">Object</span> actualKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 事务默认传播属性会共用同一个连接，因此会去 ThreadLocal 中获取连接，如果存在就直接返回</span>
		<span class="token comment">// map对应了当前数据源对象和 当前连接的绑定关系</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">Object</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Transparently remove ResourceHolder that was marked as void...</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">ResourceHolder</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResourceHolder</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// Remove entire ThreadLocal if empty...</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				resources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>执行到<code>doGetResource</code>，也就说明了，事务的执行默认使用了同一个数据库连接。</p> <p><code>doGetTransaction</code> 方法执行完返回了事务对象，返回到<code>getTransaction</code>方法中</p> <p>进入<code>doBegin</code>方法</p> <p>类文件： org.springframework.jdbc.datasource.<code>DataSourceTransactionManager</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBegin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>
		<span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// 如果没有数据库连接</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txObject<span class="token punctuation">.</span><span class="token function">hasConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
					txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 从连接池里面获取连接</span>
				<span class="token class-name">Connection</span> newCon <span class="token operator">=</span> <span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Acquired Connection [&quot;</span> <span class="token operator">+</span> newCon <span class="token operator">+</span> <span class="token string">&quot;] for JDBC transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 把连接包装成 ConnectionHolder，然后设置到事务对象中</span>
				txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectionHolder</span><span class="token punctuation">(</span>newCon<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			con <span class="token operator">=</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 从数据库连接中获取隔离级别，Mysql默认隔离级别是 可重复读</span>
			<span class="token class-name">Integer</span> previousIsolationLevel <span class="token operator">=</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">prepareConnectionForTransaction</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			txObject<span class="token punctuation">.</span><span class="token function">setPreviousIsolationLevel</span><span class="token punctuation">(</span>previousIsolationLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>con<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				txObject<span class="token punctuation">.</span><span class="token function">setMustRestoreAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Switching JDBC Connection [&quot;</span> <span class="token operator">+</span> con <span class="token operator">+</span> <span class="token string">&quot;] to manual commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 关闭连接的自动提交，其实这步就是开启了事务</span>
				con<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 设置只读事务 从这一点设置的时间点开始（时间点a）到这个事务结束的过程中，</span>
			<span class="token comment">// 其他事务所提交的数据，该事务将看不见！</span>
			<span class="token comment">// 设置只读事务就是告诉数据库，我这个事务内没有新增，修改，删除操作</span>
			<span class="token comment">// 只有查询操作，不需要数据库锁等操作，减少数据库压力</span>
			<span class="token function">prepareTransactionalConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 自己提交关闭了，就说明已经开启事务了，事务是活动的</span>
			txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTransactionActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">determineTimeout</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>TIMEOUT_DEFAULT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTimeoutInSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Bind the connection holder to the thread.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">isNewConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 如果是新创建的事务，则建立当前线程和数据库连接的关系</span>
				<span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">bindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">isNewConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> <span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CannotCreateTransactionException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not open JDBC Connection for transaction&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>doBegin</code>方法中的 <code>con.setAutoCommit(false)</code>执行完，正式开启了Spring 事务管理功能。</p></blockquote> <h2 id="事务问题汇总"><a href="#事务问题汇总" class="header-anchor">#</a> 事务问题汇总</h2> <div class="danger custom-block"><p class="custom-block-title">问题一</p> <p><code>AutoProxyRegistrar</code>是AOP的入口类，之前<code>@EnableAspectJAutoProxy</code>也会通过<code>AutoProxyRegistrar</code>生成一个AOP的入口类，那么AOP的入口类会有两个吗?</p></div> <div class="tip custom-block"><p class="custom-block-title">参考答案</p> <p>不会，Spring AOP创建的入口类名字默认都叫<code>org.springframework.aop.config.internalAutoProxyCreator</code>，并且优先级设置在<code>AopConfigUtils</code>类中：</p> <div class="language-java extra-class"><pre class="language-java"><code>
 <span class="token keyword">static</span> <span class="token punctuation">{</span>
       <span class="token comment">// 事务代理 入口类优 先级最低</span>
		APC_PRIORITY_LIST<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">InfrastructureAdvisorAutoProxyCreator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// XML代理 入口类 优先级其次</span>
		APC_PRIORITY_LIST<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AspectJAwareAdvisorAutoProxyCreator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// AspectJ代理 入口类 优先级最高</span>
		APC_PRIORITY_LIST<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>由此可见，AspectJ的入口类<code>AnnotationAwareAspectJAutoProxyCreator</code>优先级最高，也就是说如果设置了切面，那么入口类只会有<code>AnnotationAwareAspectJAutoProxyCreator</code>会起作用。</p></div> <div class="danger custom-block"><p class="custom-block-title">问题二</p> <p>两个方法上都使用了@Transactional默认传播属性，内部是如何保证使用了同一个连接的？</p></div> <div class="tip custom-block"><p class="custom-block-title">参考答案</p> <p>事务默认传播属性会共用同一个连接，内部是通过<code>ThreadLocal</code>来保证连接的重复可用。默认第一次肯定不会从<code>Map</code>中拿到连接，直接返回<code>null</code>，只有第二次进来<code>get()</code>的值才不会为空。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">doGetResource</span><span class="token punctuation">(</span><span class="token class-name">Object</span> actualKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 事务默认传播属性会共用同一个连接，因此会去 ThreadLocal 中获取连接，</span>
		<span class="token comment">// 如果存在就直接返回，否则创建新的连接</span>
		<span class="token comment">// Map保存了当前数据源对象 和 当前连接的绑定关系</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">Object</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Transparently remove ResourceHolder that was marked as void...</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">ResourceHolder</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResourceHolder</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// Remove entire ThreadLocal if empty...</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				resources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/zh/spring/[11]aop入口及aop中的各种advice和advisor.html" class="prev">
          [十一]Spring AOP - 代理入口类
        </a></span> <span class="next"><a href="/zh/spring/[13]务隔离级别缓存切面和异步切面.html">
          [十三] Spring的事务管理 - 编程式事务
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8595a84a.js" defer></script><script src="/assets/js/2.43ea25e1.js" defer></script><script src="/assets/js/143.d4c9a677.js" defer></script><script src="/assets/js/10.06e5eb14.js" defer></script>
  </body>
</html>
